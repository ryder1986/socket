Backport of:

From b7689155f3f5c4999846c07a852b1c7a43b09cec Mon Sep 17 00:00:00 2001
From: "djm@openbsd.org" <djm@openbsd.org>
Date: Wed, 28 Sep 2016 21:44:52 +0000
Subject: [PATCH] upstream commit

put back some pre-auth zlib bits that I shouldn't have
removed - they are still used by the client. Spotted by naddy@

Upstream-ID: 80919468056031037d56a1f5b261c164a6f90dc2
---
 kex.c    | 4 +++-
 kex.h    | 5 +++--
 packet.c | 7 ++++---
 3 files changed, 10 insertions(+), 6 deletions(-)

Index: openssh-7.2p2/kex.c
===================================================================
--- openssh-7.2p2.orig/kex.c	2018-01-15 09:48:31.399312732 -0500
+++ openssh-7.2p2/kex.c	2018-01-15 09:48:31.399312732 -0500
@@ -687,6 +687,8 @@ choose_comp(struct sshcomp *comp, char *
 		return SSH_ERR_NO_COMPRESS_ALG_MATCH;
 	if (strcmp(name, "zlib@openssh.com") == 0) {
 		comp->type = COMP_DELAYED;
+	} else if (strcmp(name, "zlib") == 0) {
+		comp->type = COMP_ZLIB;
 	} else if (strcmp(name, "none") == 0) {
 		comp->type = COMP_NONE;
 	} else {
Index: openssh-7.2p2/kex.h
===================================================================
--- openssh-7.2p2.orig/kex.h	2018-01-15 09:48:31.399312732 -0500
+++ openssh-7.2p2/kex.h	2018-01-15 09:48:31.399312732 -0500
@@ -60,7 +60,8 @@
 #define	KEX_CURVE25519_SHA256	"curve25519-sha256@libssh.org"
 
 #define COMP_NONE	0
-#define COMP_DELAYED	1
+#define COMP_ZLIB	1
+#define COMP_DELAYED	2
 
 #define CURVE25519_SIZE 32
 
Index: openssh-7.2p2/packet.c
===================================================================
--- openssh-7.2p2.orig/packet.c	2018-01-15 09:48:31.399312732 -0500
+++ openssh-7.2p2/packet.c	2018-01-15 09:48:31.399312732 -0500
@@ -928,8 +928,9 @@ ssh_set_newkeys(struct ssh *ssh, int mod
 	/* explicit_bzero(enc->iv,  enc->block_size);
 	   explicit_bzero(enc->key, enc->key_len);
 	   explicit_bzero(mac->key, mac->key_len); */
-	if (comp->type == COMP_DELAYED && state->after_authentication &&
-	    comp->enabled == 0) {
+	if ((comp->type == COMP_ZLIB ||
+	    (comp->type == COMP_DELAYED &&
+	     state->after_authentication)) && comp->enabled == 0) {
 		if ((r = ssh_packet_init_compression(ssh)) < 0)
 			return r;
 		if (mode == MODE_OUT) {
